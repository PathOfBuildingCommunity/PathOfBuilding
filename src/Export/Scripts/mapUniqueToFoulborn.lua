if not table.containsId then
	dofile("Scripts/mods.lua")
end
dofile("Scripts/flavourText.lua")

local foulbornMods = LoadModule("../Data/ModFoulborn.lua")
local uniques = LoadModule("../Data/FlavourText.lua")
local finalUniqueMap = { }
local out = io.open("../Data/ModFoulbornMap.lua", "w")
out:write('-- This file is automatically generated, do not edit!\n')
out:write('-- Item data (c) Grinding Gear Games\n\nreturn {\n')
local mappedMods = { }

for _, unique in ipairs(uniques) do
	local uniqueName = unique.name
	for modId, mod in pairsSortByKey(foulbornMods) do
		local sanitizedModId = modId:gsub("Amluet","Amulet"):gsub("Botts","Boots"):gsub("HelmetDex2","DexHelmet2"):gsub("HelmetInt2","IntHelmet2")
		if sanitizedModId:match(unique.id .. "%a+") then
			if not finalUniqueMap[uniqueName] then
				finalUniqueMap[uniqueName] = {}
			end
			table.insert(finalUniqueMap[uniqueName], mod)
			mappedMods[modId] = true
		end
	end
end

for uniqueName, modList in pairsSortByKey(finalUniqueMap) do
	out:write('\t["', uniqueName, '"] = {\n')
	for _, mod in ipairs(modList) do
		out:write('\t\t"', table.concat(mod, " "), '",\n')
	end
	out:write('\t},\n')
end
out:write('}\n')
out:close()

print("Foulborn mod map updated.")

local unmappedMods = {}
for modId, mod in pairsSortByKey(foulbornMods) do
	if not mappedMods[modId] then
		table.insert(unmappedMods, string.format("%s (%s)", modId, table.concat(mod, " ")))
	end
end

if #unmappedMods > 0 then
	print(string.format("Found %d Foulborn mods without a matching unique:", #unmappedMods))
	for _, modLine in ipairs(unmappedMods) do
		print(" - " .. modLine)
	end
end
