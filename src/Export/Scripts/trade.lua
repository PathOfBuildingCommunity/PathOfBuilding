local dkjson = require "dkjson"

-- loading league
print("Downloading league and realm info")
launch:DownloadPage(
	"https://www.pathofexile.com/api/leagues?type=main&compact=1",
	function(response, errMsg)
		if errMsg then
			return "POE ERROR", "Error: "..errMsg
		else
			local json_data = dkjson.decode(response.body)
			if not json_data then
				return "Failed to Get PoE League List response"
			end
			table.sort(json_data, function(a, b)
				if a.endAt == nil then return false end
				if b.endAt == nil then return true end
				return #a.id < #b.id
			end)
			
			local out = io.open("../Data/TradeLeagueInfo.lua", "w")
			out:write('-- This file is automatically generated, do not edit!\n')
			out:write('-- Gem data (c) Grinding Gear Games\n\nreturn {\n')
			for _, league_data in pairs(json_data) do
				if not league_data.id:find("SSF") then
					out:write('\t["', league_data.id, '"] = {\n')
					out:write('\t\t["url"] = "', league_data.url, '",\n')
					out:write('\t\t["realm"] = "', league_data.realm, '",\n')
					out:write('\t},\n')
				end
			end
			out:write('}')
			out:close()
		end
	end
)